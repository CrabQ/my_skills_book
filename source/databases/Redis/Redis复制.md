# Redis复制

## 主从复制

1. 数据副本
2. 扩展读性能

```shell
一个master可以有多个slave
一个slave只能有一个master
数据流向是单向的,master到slave
```

### 主从复制的实现

slaveof命令

```shell
# 成为127.0.0.1 6379的从节点
slaveof 127.0.0.1 6379

# 取消从节点,数据不会删除,重新成为从节点时会清除当前所有数据
slaveof no one
```

配置

```shell
slaveof ip port
# 只读
slave-read-only yes
```

### 全量复制

主从复制的同时,这期间写入的数据会在缓冲区记录下来,同样发送给从节点,保证数据一致

全量复制的开销

```shell
bgsave时间
RDB文件网络传输时间
从节点清楚数据时间
从节点夹在RDB的时间
可能的AOF重写时间
```

部分复制

### 主从复制常见问题

#### 读写分离

读写分析: 读流量分摊到从节点
可能遇到的问题

- 复制数据延迟
- 读到过期数据
- 从节点故障

#### 配置不一致

1. 例如maxmemory不一致:丢失数据
2. 例如数据结构优化参数(例如hash-max-ziplist-entries):内存不一致

#### 规避全量复制

1. 第一次全量复制
    - 第一次不可避免
    - 小主节点,低峰

2. 节点运行ID不匹配
    - 主节点重启(运行ID变化)
    - 故障转移,例如哨兵或集群

3. 复制积压缓冲区不足
    - 网络中断,部分复制无法满足
    - 增大复制缓冲区配置rel_backlog_size,网络增强

#### 规避复制风暴

单主节点复制风暴

```shell
问题: 主节点重启,多从节点复制
解决: 更换复制拓扑
```

单机器复制风暴

```shell
机器宕机后,大量全量复制
主节点分散多机器
```
