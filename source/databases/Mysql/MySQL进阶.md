# MySQL进阶

## 索引

### 什么是索引

索引是一种数据结构,可以帮助我们快速的进行数据的查找.

### 索引是个什么样的数据结构

索引的数据结构和具体存储引擎的实现有关, 在MySQL中使用较多的索引有Hash索引,B+树索引等,而我们经常使用的InnoDB存储引擎的默认索引实现为:B+树索引.

### Hash索引和B+树所有有什么区别

hash索引底层就是hash表,进行查找时,调用一次hash函数就可以获取到相应的键值,之后进行回表查询获得实际数据.B+树底层实现是多路平衡查找树.对于每一次的查询都是从根节点出发,查找到叶子节点方可以获得所查键值,然后根据查询判断是否需要回表查询数据.

####　区别

hash索引进行等值查询更快(一般情况下),但是却无法进行范围查询.

因为在hash索引中经过hash函数建立索引之后,索引的顺序与原顺序无法保持一致,不能支持范围查询.而B+树的的所有节点皆遵循(左节点小于父节点,右节点大于父节点,多叉树也类似),天然支持范围.

- hash索引不支持使用索引进行排序,原理同上.
- hash索引不支持模糊查询以及多列索引的最左前缀匹配.原理也是因为hash函数的不可预测.AAAA和AAAAB的索引没有相关性.
- hash索引任何时候都避免不了回表查询数据,而B+树在符合某些条件(聚簇索引,覆盖索引等)的时候可以只通过索引完成查询.
- hash索引虽然在等值查询上较快,但是不稳定.性能不可预测,当某个键值存在大量重复的时候,发生hash碰撞,此时效率可能极差.而B+树的查询效率比较稳定,对于所有的查询都是从根节点到叶子节点,且树的高度较低.

因此,在大多数情况下,直接选择B+树索引可以获得稳定且较好的查询速度.而不需要使用hash索引.

### 什么是聚簇索引

在B+树的索引中,叶子节点可能存储了当前的key值,也可能存储了当前的key值以及整行的数据,这就是聚簇索引和非聚簇索引. 在InnoDB中,只有主键索引是聚簇索引,如果没有主键,则挑选一个唯一键建立聚簇索引.如果没有唯一键,则隐式的生成一个键来建立聚簇索引.

当查询使用聚簇索引时,在对应的叶子节点,可以获取到整行数据,因此不用再次进行回表查询.

### 非聚簇索引一定会回表查询吗

不一定,这涉及到查询语句所要求的字段是否全部命中了索引,如果全部命中了索引,那么就不必再进行回表查询.

举个简单的例子,假设我们在员工表的年龄上建立了索引,那么当进行select age from employee where age < 20的查询时,在索引的叶子节点上,已经包含了age信息,不会再次进行回表查询.

### 在建立索引的时候,都有哪些需要考虑的因素

建立索引的时候一般要考虑到字段的使用频率,经常作为条件进行查询的字段比较适合.如果需要建立联合索引的话,还需要考虑联合索引中的顺序.此外也要考虑其他方面,比如防止过多的索引对表造成太大的压力.这些都和实际的表结构以及查询方式有关.

### 联合索引是什么?为什么需要注意联合索引中的顺序

MySQL可以使用多个字段同时建立一个索引,叫做联合索引.在联合索引中,如果想要命中索引,需要按照建立索引时的字段顺序挨个使用,否则无法命中索引.

MySQL使用索引时需要索引有序,假设现在建立了"name,age,school"的联合索引,那么索引的排序为: 先按照name排序,如果name相同,则按照age排序,如果age的值也相等,则按照school进行排序.

当进行查询时,此时索引仅仅按照name严格有序,因此必须首先使用name字段进行等值查询,之后对于匹配到的列而言,其按照age字段严格有序,此时可以使用age字段用做索引查找,,,以此类推.因此在建立联合索引的时候应该注意索引列的顺序,一般情况下,将查询需求频繁或者字段选择性高的列放在前面.此外可以根据特例的查询或者表结构进行单独的调整.

### 创建的索引有没有被使用到?或者说怎么才可以知道这条语句运行很慢的原因

MySQL提供了explain命令来查看语句的执行计划,MySQL在执行某个语句之前,会将该语句过一遍查询优化器,之后会拿到对语句的分析,也就是执行计划,其中包含了许多信息. 可以通过其中和索引有关的信息来分析是否命中了索引,例如possilbe_key,key,key_len等字段,分别说明了此语句可能会使用的索引,实际使用的索引以及使用的索引长度.

### 在哪些情况下会发生针对该列创建了索引但是在查询的时候并没有使用

- 使用不等于查询,
- 列参与了数学运算或者函数
- 在字符串like时左边是通配符.类似于'%aaa'.
- 当mysql分析全表扫描比使用索引快的时候不使用索引.
- 当使用联合索引,前面一个条件为范围查询,后面的即使符合最左前缀原则,也无法使用索引.

以上情况,MySQL无法使用索引.

## 事务

### 什么是事务

Transaction

    事务是数据库并发控制的基本单位
    事务可以看做是一系列SQL语句的集合
    事务必须要么全部执行成功,要么全部执行失败(回滚)

### ACID是事务的四个基本特性

    原子性(Atomicity):一个事务中所有操作全部完成或失败
    一致性(Consistency):事务开始和结束之后数据完整性没有被破坏
    隔离性(Isolation):允许多个事务同时对数据库修改和读写
    持久性(Durability):事务结束之后,修改是永久的不会丢失

### 事务的并发控制

如果不对事务进行并发控制,可能会产生四种异常情况

    幻读(phantom read):一个事务第二次查出现第一次没有的结果
    非重复读(nonrepeatable read):一个事务重复读两次得到不同结果
    脏读(dirty read):一个事务读取到另一个事务没有提交的修改
    丢失修改(lost update):并发写入造成其中一些修改丢失

### 四种事务隔离级别

为了解决并发控制异常,定义了4种事务隔离级别

    读未提交(read uncommitted):别的事物可以读取到未提交改变
    读已提交(read committed):只能读取已经提交的数据
    可重复读(repeatable read):同一个事务先后查询结果一样(Mysql innodb默认)
    串行话(Serializable):事务完全串行化的执行,隔离级别最高,执行效率最低

## Mysql索引原理及优化

### 什么是索引

    索引是数据表中一个或者多个列进行排序的数据结构
    索引能够大幅提升检索速度(查找结构)
    创建,更新索引本身也会耗费空间和时间

### 什么是B-Tree

    多路平衡查找数(每个节点最多m(m>=2)个孩子,成为m阶或者度)
    叶节点具有相同的深度
    节点中的数据key从左到右是递增的

### B+Tree

B+树是B-Tree的变形

    Mysql实际使用的B+Tree作为索引的数据结构
    只在叶子节点带有指向记录的指针(可以增加树的度)
    叶子节点通过指针相连.(实现范围查询)

### Mysql索引的类型

    普通索引(CREATE INDEX)
    唯一索引,索引列的值必须唯一(CREATE UNIQUE INDEX)
    多列索引
    主键索引(PRIMARY KEY),一个表只能有一个
    全文索引(FULLTEXT INDEX), InnoDB不支持

### 什么时候创建索引

建表的时候需要根据查询需求来创建索引

    经常用做查询条件的字段(WHERE条件)
    经常用作表连接的字段
    经常出现在order by, group by之后的字段

### 创建索引有哪些需要注意的

    非空字段 NOT NULL, Mysql很难对空值作查询优化
    区分度高,离散度大,作为索引的字段值尽量不要有大量相同值
    索引的长度不要太长(比较消耗时间)

### 索引什么时候失效

模糊匹配,类型隐转,最左匹配

    以%开头的LIKE语句,模糊搜索
    出现隐式类型转换(在Python这种动态语言查询中需要注意)
    没有满足最左前缀原则

### 什么是聚集索引和非聚集索引

    聚集还是非聚集指的是B+Tree叶节点存的是指针还是数据记录
    MyISAM索引和数据分离,使用的是非聚集索引
    InnoDB数据文件就是索引文件,主键索引就是聚集索引

## 如何排查慢查询

慢查询通常是缺少索引,索引不合理或者业务代码实现导致

    slow_query_log_file 开启并且查询慢查询日志
    通过explain排查索引问题
    调整数据修改索引;业务代码层限制不合理访问

## 如何解决高并发场景下的插入重复

高并发场景下,写入数据库会有数据重复问题

    使用数据库的唯一索引
    使用队列异步导入
    使用redis等实现分布式锁

## 乐观锁和悲观锁

    悲观锁是先获取锁再操作.一锁二查三更新 select for update
    乐观锁先修改,更新的时候发现数据已经变了就回滚(check and set)
    乐观锁一般通过版本号或者时间戳实现
    需要根据响应速度,冲突频率,重试代价来判断使用哪一种

## InnoDB vs MyISAM

    MyISAM不支持事务,InnoDB支持事务
    MyISAM不支持外键,InnoDB支持外键
    MyISAM只支持表锁,InnoDB支持行锁和表锁
    MyISAM支持全文索引,InnoDB不支持全文索引
